{% extends 'core/base.html' %}
{% load django_bootstrap5 %}

{% block title %}Визуализация склада - Box Point{% endblock %}

{% block extra_head %}
<style>
    .cell-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .storage-card {
        transition: all 0.3s ease;
    }
    
    .storage-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }
    
    .tooltip-inner {
        max-width: 350px;
        text-align: left;
        padding: 0.75rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        opacity: 1 !important;
    }
    
    .tooltip-inner table {
        margin-bottom: 0;
        color: white;
    }
    
    .tooltip-inner table th,
    .tooltip-inner table td {
        padding: 0.25rem;
    }
    
    .badge-order {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .badge-order:hover {
        transform: scale(1.05);
    }
    
    .cell-status-indicator {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
    }
    
    .indicator-free {
        background-color: #28a745;
    }
    
    .indicator-occupied {
        background-color: #dc3545;
    }
    
    /* Filters and sorting controls */
    .filter-controls {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-primary text-white">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0"><i class="fas fa-warehouse me-2"></i> Карта склада</h1>
                    <p class="mb-0">Визуализация ячеек хранения и размещения заказов</p>
                </div>
                <div>
                    <div class="d-flex gap-2 align-items-center">
                        <div class="text-center">
                            <div class="fs-4 fw-bold">{{ total_cells_count }}</div>
                            <div class="small">Всего</div>
                        </div>
                        <div class="text-center bg-success rounded px-3 py-2">
                            <div class="fs-4 fw-bold">{{ free_cells_count }}</div>
                            <div class="small">Свободно</div>
                        </div>
                        <div class="text-center bg-danger rounded px-3 py-2">
                            <div class="fs-4 fw-bold">{{ occupied_cells_count }}</div>
                            <div class="small">Занято</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-white">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
            <div>
                <h5 class="mb-0"><i class="fas fa-boxes text-primary me-2"></i>Ячейки хранения</h5>
            </div>
            <div>
                <form method="get" class="d-flex">
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" 
                               placeholder="Поиск по номеру ячейки" value="{{ search_query }}"
                               aria-label="Поиск по номеру ячейки">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <!-- Storage visualization status -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <div class="progress" style="height: 25px;">
                            {% if total_cells_count > 0 %}
                            {% with free_percent=free_cells_count|floatformat:0 occupied_percent=occupied_cells_count|floatformat:0 %}
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {% widthratio free_cells_count total_cells_count 100 %}%;" 
                                 aria-valuenow="{{ free_percent }}" aria-valuemin="0" aria-valuemax="100">
                                {{ free_cells_count }} свободно ({{ free_percent }}%)
                            </div>
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: {% widthratio occupied_cells_count total_cells_count 100 %}%;" 
                                 aria-valuenow="{{ occupied_percent }}" aria-valuemin="0" aria-valuemax="100">
                                {{ occupied_cells_count }} занято ({{ occupied_percent }}%)
                            </div>
                            {% endwith %}
                            {% else %}
                            <div class="progress-bar" role="progressbar" style="width: 0%;" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-2 small text-muted">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filter controls -->
        <div class="filter-controls mb-4">
            <div class="row">
                <div class="col-md-4 mb-3 mb-md-0">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showOccupied" checked>
                        <label class="form-check-label" for="showOccupied">Занятые ячейки</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showFree" checked>
                        <label class="form-check-label" for="showFree">Свободные ячейки</label>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">Сортировка</span>
                        <select class="form-select form-select-sm" id="sortCells">
                            <option value="number">По номеру ячейки</option>
                            <option value="status">По статусу</option>
                        </select>
                        <button class="btn btn-outline-secondary" type="button" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i> Обновить
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cell grid -->
        <div class="cell-grid" id="cellsContainer">
            {% for cell in cells %}
                <div class="card storage-card mb-0 position-relative {% if cell.is_occupied %}occupied{% else %}free{% endif %}" 
                     data-status="{% if cell.is_occupied %}occupied{% else %}free{% endif %}" 
                     data-cell-number="{{ cell.number }}">
                    <div class="cell-status-indicator {% if cell.is_occupied %}indicator-occupied{% else %}indicator-free{% endif %}"></div>
                    <div class="card-header d-flex justify-content-between align-items-center {% if cell.is_occupied %}bg-danger text-white{% else %}bg-success text-white{% endif %}">
                        <strong>{{ cell.number }}</strong>
                        <span class="badge bg-light text-{% if cell.is_occupied %}danger{% else %}success{% endif %}">
                            {{ cell.is_occupied|yesno:"Занята,Свободна" }}
                        </span>
                    </div>
                    <div class="card-body">
                        {% if cell.is_occupied %}
                            <h6 class="card-title d-flex justify-content-between">
                                <span>Клиент:</span>
                                <a href="{% url 'pickup_process' pk=cell.current_customer.id %}" class="text-decoration-none">
                                    {{ cell.current_customer.name }}
                                </a>
                            </h6>
                            {% if cell.orders.all %}
                                <p class="small text-muted mb-2">Заказы в ячейке:</p>
                                <div class="d-flex flex-wrap gap-1 mb-2">
                                    {% for order in cell.orders.all %}
                                        <span class="badge bg-info text-dark badge-order" 
                                              data-bs-toggle="tooltip" 
                                              data-bs-html="true"
                                              data-bs-placement="top"
                                              data-bs-custom-class="tooltip-rich"
                                              data-bs-title="
                                                <div class='p-1'>
                                                    <h6 class='mb-2 border-bottom pb-1'>{{ order.name }}</h6>
                                                    <table class='w-100'>
                                                        <tr>
                                                            <th>ID:</th>
                                                            <td>{{ order.order_id }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Размер:</th>
                                                            <td>{{ order.size|default:'Не указан' }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Цвет:</th>
                                                            <td>{{ order.color|default:'Не указан' }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Цена:</th>
                                                            <td>{{ order.price }} ₽</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Оплата:</th>
                                                            <td>{{ order.get_payment_status_display }}</td>
                                                        </tr>
                                                    </table>
                                                    {% if order.description %}
                                                    <div class='mt-2 small'>
                                                        <strong>Описание:</strong><br>
                                                        {{ order.description|truncatechars:100 }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                              ">
                                            {{ order.order_id }}
                                        </span>
                                    {% endfor %}
                                </div>
                                <div class="mt-3 small">
                                    <a href="#" class="btn btn-sm btn-outline-secondary w-100">
                                        <i class="fas fa-info-circle me-1"></i> Подробнее о заказах
                                    </a>
                                </div>
                            {% else %}
                                <div class="alert alert-warning py-2 mb-0 small">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Ячейка занята, но заказы не найдены.
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="text-center text-success py-3">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <p class="mb-0">Ячейка свободна</p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-light p-2 small">
                        <div class="d-flex justify-content-center">
                            {% if cell.is_occupied %}
                                <a href="{% url 'pickup_process' pk=cell.current_customer.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-dolly me-1"></i> Перейти к выдаче
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12 text-center py-5">
                    <div class="py-5">
                        <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
                        <h5>Ячейки хранения не найдены</h5>
                        <p class="text-muted">Сначала создайте ячейки хранения в разделе "Система"</p>
                        <a href="{% url 'system' %}" class="btn btn-primary mt-2">
                            <i class="fas fa-cogs me-1"></i> Перейти в настройки
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        {% if is_paginated %}
        <div class="mt-4">
            {% bootstrap_pagination page_obj %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Back button -->
<div class="mb-4">
    <a href="{% url 'home' %}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-1"></i> Вернуться на главную
    </a>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips with HTML support
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            delay: {show: 200, hide: 100}
        });
    });
    
    // Filter functionality
    const showOccupiedCheckbox = document.getElementById('showOccupied');
    const showFreeCheckbox = document.getElementById('showFree');
    const sortSelect = document.getElementById('sortCells');
    const cellsContainer = document.getElementById('cellsContainer');
    const refreshBtn = document.getElementById('refreshBtn');
    const cells = document.querySelectorAll('.storage-card');
    
    // Filter and sort functions
    function updateCellVisibility() {
        const showOccupied = showOccupiedCheckbox.checked;
        const showFree = showFreeCheckbox.checked;
        
        cells.forEach(cell => {
            const status = cell.dataset.status;
            
            if ((status === 'occupied' && showOccupied) || 
                (status === 'free' && showFree)) {
                cell.style.display = '';
            } else {
                cell.style.display = 'none';
            }
        });
    }
    
    function sortCells() {
        const sortValue = sortSelect.value;
        const cellsArray = Array.from(cells);
        
        cellsArray.sort((a, b) => {
            if (sortValue === 'status') {
                if (a.dataset.status === b.dataset.status) {
                    return a.dataset.cellNumber.localeCompare(b.dataset.cellNumber, undefined, {numeric: true});
                }
                return a.dataset.status === 'free' ? -1 : 1;
            } else {
                return a.dataset.cellNumber.localeCompare(b.dataset.cellNumber, undefined, {numeric: true});
            }
        });
        
        // Remove all cells from container
        cellsArray.forEach(cell => cell.remove());
        
        // Add sorted cells back
        cellsArray.forEach(cell => cellsContainer.appendChild(cell));
    }
    
    // Event listeners
    showOccupiedCheckbox.addEventListener('change', updateCellVisibility);
    showFreeCheckbox.addEventListener('change', updateCellVisibility);
    sortSelect.addEventListener('change', sortCells);
    refreshBtn.addEventListener('click', function() {
        location.reload();
    });
    
    // Initialize sorting
    sortCells();
});
</script>
{% endblock %}