{% extends 'core/base.html' %}

{% load django_bootstrap5 %}

{% block title %}Box Point - Подтверждение выдачи{% endblock %}

{% block extra_head %}
<style>
    .order-row {
        transition: all 0.2s ease-in-out;
    }
    
    .order-row:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    .order-row.disabled {
        opacity: 0.6;
    }
    
    .order-summary {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }
    
    .price-badge {
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .calculation-table tr th,
    .calculation-table tr td {
        padding: 0.75rem;
    }
    
    .calculation-table tr.total {
        font-size: 1.15rem;
    }
    
    .summary-card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        text-align: center;
    }
    
    .summary-card .card-body {
        padding: 1.25rem;
    }
    
    .summary-number {
        font-size: 2rem;
        font-weight: 500;
        margin-bottom: 0;
    }
    
    .summary-caption {
        color: #6c757d;
        margin-bottom: 0;
    }
    
    .delivery-status-icon {
        font-size: 1.25rem;
        width: 1.5rem;
        text-align: center;
    }
    
    .cell-badge {
        font-family: monospace;
        display: inline-block;
        min-width: 3rem;
        text-align: center;
    }
    
    .confirmation-form {
        position: sticky;
        top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-primary text-white">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0"><i class="fas fa-check-circle me-2"></i> Подтверждение выдачи</h1>
                    <p class="mb-0">Проверьте данные и завершите процесс выдачи</p>
                </div>
                <a href="{% url 'pickup_process' pk=object.customer.id %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-1"></i> К списку заказов
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i> Клиент: {{ object.customer.name }}</h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-light text-dark"><i class="fas fa-id-card me-1"></i> ID: {{ object.customer.id }}</span>
                        {% if object.customer.phone %}
                        <span class="badge bg-light text-dark"><i class="fas fa-phone me-1"></i> {{ object.customer.phone }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <!-- Сводка по заказам -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-box-open text-primary me-2"></i>Сводка по заказам</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="summary-card bg-primary bg-opacity-10">
                            <div class="card-body">
                                <p class="summary-number" id="delivered-count">{{ delivered_count }}</p>
                                <p class="summary-caption">К выдаче</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-card bg-danger bg-opacity-10">
                            <div class="card-body">
                                <p class="summary-number">{{ returned_count }}</p>
                                <p class="summary-caption">На возврат</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="summary-card bg-secondary bg-opacity-10">
                            <div class="card-body">
                                <p class="summary-number">{{ pending_count }}</p>
                                <p class="summary-caption">Не выбрано</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if returned_count > 0 %}
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Внимание!</strong> У клиента есть товары, отмеченные на возврат. После завершения выдачи товары будут обработаны согласно правилам возврата.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Список заказов для выдачи -->
        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list-alt text-success me-2"></i>Заказы для выдачи</h5>
                <span class="badge bg-success" id="counter-to-deliver">{{ delivered_count }}</span>
            </div>
            <div class="card-body p-0">
                <form method="post" id="confirmation-form">
                    {% csrf_token %}
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllOrders" checked>
                                            <label class="form-check-label" for="selectAllOrders">
                                                Все
                                            </label>
                                        </div>
                                    </th>
                                    <th>Заказ</th>
                                    <th>Детали</th>
                                    <th class="text-center">Ячейка</th>
                                    <th class="text-end">Стоимость</th>
                                    <th>Статус выдачи</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                    {% if order.id|stringformat:"i" in selected_orders and not order.marked_for_return %}
                                    <tr class="order-row" 
                                        data-order-id="{{ order.id }}" data-price="{{ order.price }}" 
                                        data-payment="{{ order.payment_status }}">
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input order-checkbox" type="checkbox" name="deliver_orders" 
                                                       value="{{ order.id }}" id="order_{{ order.id }}" checked>
                                                <label class="form-check-label" for="order_{{ order.id }}"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ order.order_id }}</strong> – {{ order.name }}
                                                {% if order.description %}
                                                <div class="small text-muted">{{ order.description|truncatechars:50 }}</div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="small">
                                                {% if order.size %}<div><strong>Размер:</strong> {{ order.size }}</div>{% endif %}
                                                {% if order.color %}<div><strong>Цвет:</strong> {{ order.color }}</div>{% endif %}
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary cell-badge">{{ order.storage_cell.number }}</span>
                                        </td>
                                        <td class="text-end">
                                            <span class="price-badge">{{ order.price }} ₽</span>
                                            <div class="small">
                                                {% if order.payment_status == 'prepaid' %}
                                                <span class="badge bg-success">Предоплата</span>
                                                {% else %}
                                                <span class="badge bg-warning text-dark">Постоплата</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-success delivery-status" data-order-id="{{ order.id }}">
                                                <i class="fas fa-check-circle me-1"></i> Выдать
                                            </span>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                                
                                {% for order in orders %}
                                    {% if order.marked_for_return %}
                                    <tr class="order-row return" data-order-id="{{ order.id }}" data-price="{{ order.price }}">
                                        <td>
                                            <div class="delivery-status-icon">
                                                <i class="fas fa-undo-alt text-danger" title="Отмечен на возврат"></i>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ order.order_id }}</strong> – {{ order.name }}
                                                {% if order.description %}
                                                <div class="small text-muted">{{ order.description|truncatechars:50 }}</div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="small">
                                                {% if order.size %}<div><strong>Размер:</strong> {{ order.size }}</div>{% endif %}
                                                {% if order.color %}<div><strong>Цвет:</strong> {{ order.color }}</div>{% endif %}
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary cell-badge">{{ order.storage_cell.number }}</span>
                                        </td>
                                        <td class="text-end">
                                            <span class="price-badge">{{ order.price }} ₽</span>
                                            <div class="small">
                                                {% if order.payment_status == 'prepaid' %}
                                                <span class="badge bg-success">Предоплата</span>
                                                {% else %}
                                                <span class="badge bg-warning text-dark">Постоплата</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-danger">
                                                <i class="fas fa-undo-alt me-1"></i> Возврат
                                            </span>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
        
        <div class="col-lg-4">
            <!-- Финансовый расчет -->
            <div class="confirmation-form">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Финансовый расчет</h5>
                    </div>
                    <div class="card-body">
                        <table class="table calculation-table">
                            <tbody>
                                <tr>
                                    <td>Предоплаченные товары</td>
                                    <td class="text-end" id="prepaid-total">{{ prepaid_total }} ₽</td>
                                </tr>
                                <tr>
                                    <td>Необходимо оплатить</td>
                                    <td class="text-end" id="postpaid-total">{% if postpaid_total %}{{ postpaid_total }} ₽{% else %}0 ₽{% endif %}</td>
                                </tr>
                                {% if include_package %}
                                <tr>
                                    <td>Стоимость пакета</td>
                                    <td class="text-end">50 ₽</td>
                                </tr>
                                {% endif %}
                                {% if refund_total %}
                                <tr>
                                    <td>Сумма к возврату</td>
                                    <td class="text-end text-danger" id="refund-total">{{ refund_total }} ₽</td>
                                </tr>
                                {% endif %}
                                <tr class="table-light total">
                                    <th>ИТОГО к оплате</th>
                                    <th class="text-end text-success" id="total-payment">
                                        {% if postpaid_total %}{{ postpaid_total }} ₽{% else %}0 ₽{% endif %}
                                    </th>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="include_package" name="include_package" 
                                   {% if object.include_package %}checked{% endif %} value="true">
                            <label class="form-check-label" for="include_package">
                                Добавить пакет (+50 ₽)
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Инструкции и кнопки -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-primary"></i>Важная информация</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Пожалуйста, проверьте информацию!</strong> После подтверждения операцию нельзя будет отменить.
                        </div>
                        
                        <ul class="mb-0">
                            <li>Выбранные заказы будут выданы клиенту</li>
                            <li>Заказы, отмеченные на возврат, будут обработаны согласно правилам</li>
                            <li>Если все заказы клиента обработаны, ячейка будет освобождена</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-body p-3">
                        <div class="d-grid gap-3">
                            <button type="submit" form="confirmation-form" class="btn btn-success btn-lg">
                                <i class="fas fa-check-circle me-2"></i> Завершить выдачу
                            </button>
                            <a href="{% url 'pickup_process' pk=object.customer.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i> Вернуться к выбору
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Селекторы элементов
        const checkboxes = document.querySelectorAll('.order-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllOrders');
        const deliveredCountEl = document.getElementById('delivered-count');
        const counterToDeliverEl = document.getElementById('counter-to-deliver');
        const prepaidTotalEl = document.getElementById('prepaid-total');
        const postpaidTotalEl = document.getElementById('postpaid-total');
        const totalPaymentEl = document.getElementById('total-payment');
        const includePackageCheckbox = document.getElementById('include_package');
        
        // Стоимость пакета
        const PACKAGE_PRICE = 50; // руб.
        
        // Функция для обновления статуса выдачи
        function updateDeliveryStatus(checkbox) {
            const orderId = checkbox.value;
            const statusBadge = document.querySelector(`.delivery-status[data-order-id="${orderId}"]`);
            
            if (checkbox.checked) {
                statusBadge.className = 'badge bg-success delivery-status';
                statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i> Выдать';
            } else {
                statusBadge.className = 'badge bg-secondary delivery-status';
                statusBadge.innerHTML = '<i class="fas fa-times-circle me-1"></i> Оставить';
                
                // Затемняем строку для визуального индикатора
                const row = checkbox.closest('tr');
                row.classList.add('disabled');
            }
        }
        
        // Функция для пересчета итоговых сумм
        function recalculateAmounts() {
            let prepaidTotal = 0;
            let postpaidTotal = 0;
            let deliveredCount = 0;
            
            // Перебираем все чекбоксы
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    deliveredCount++;
                    
                    // Получаем родительскую строку (tr)
                    const row = checkbox.closest('tr');
                    // Получаем цену из данных строки
                    const price = parseFloat(row.dataset.price);
                    
                    // Определяем статус оплаты
                    const paymentStatus = row.dataset.payment;
                    if (paymentStatus === 'prepaid') {
                        prepaidTotal += price;
                    } else {
                        postpaidTotal += price;
                    }
                }
            });
            
            // Добавляем стоимость пакета
            if (includePackageCheckbox && includePackageCheckbox.checked) {
                postpaidTotal += PACKAGE_PRICE;
            }
            
            // Обновляем отображение
            deliveredCountEl.textContent = deliveredCount;
            counterToDeliverEl.textContent = deliveredCount;
            prepaidTotalEl.textContent = prepaidTotal.toFixed(2) + ' ₽';
            postpaidTotalEl.textContent = postpaidTotal.toFixed(2) + ' ₽';
            totalPaymentEl.textContent = postpaidTotal.toFixed(2) + ' ₽';
            
            // Обновляем статус чекбоксов
            checkboxes.forEach(checkbox => {
                updateDeliveryStatus(checkbox);
            });
        }
        
        // Обработчик для чекбокса "Выбрать все"
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    // Обновляем состояние строки
                    const row = checkbox.closest('tr');
                    if (this.checked) {
                        row.classList.remove('disabled');
                    } else {
                        row.classList.add('disabled');
                    }
                });
                recalculateAmounts();
            });
        }
        
        // Обработчики для отдельных чекбоксов
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                recalculateAmounts();
                
                // Обновляем статус "Выбрать все"
                if (selectAllCheckbox) {
                    let allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                }
            });
            
            // Инициализируем статус строки
            const row = checkbox.closest('tr');
            if (!checkbox.checked) {
                row.classList.add('disabled');
            }
        });
        
        // Обработчик для чекбокса "Добавить пакет"
        if (includePackageCheckbox) {
            includePackageCheckbox.addEventListener('change', recalculateAmounts);
        }
        
        // Подтверждение перед отправкой формы
        const confirmationForm = document.getElementById('confirmation-form');
        if (confirmationForm) {
            confirmationForm.addEventListener('submit', function(e) {
                const totalPayment = parseFloat(totalPaymentEl.textContent);
                
                // Проверяем, выбран ли хотя бы один заказ
                const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                if (!anyChecked) {
                    e.preventDefault();
                    alert('Не выбрано ни одного заказа для выдачи. Отметьте хотя бы один заказ.');
                    return false;
                }
                
                // Подтверждаем оплату, если требуется
                if (totalPayment > 0) {
                    if (!confirm(`Клиент должен оплатить ${totalPaymentEl.textContent}. Подтверждаете получение оплаты?`)) {
                        e.preventDefault();
                        return false;
                    }
                }
                
                return true;
            });
        }
        
        // Инициализация при загрузке страницы
        recalculateAmounts();
    });
</script>
{% endblock %}